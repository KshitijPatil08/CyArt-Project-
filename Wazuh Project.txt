#!/bin/bash
# Automated Project Setup Script - FREE SOLUTION
# This creates the entire project structure locally
# You can then push to GitHub (free) or share via Google Drive

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   Wazuh Device Visualization Project Setup    â•‘"
echo "â•‘   Creating complete project structure...      â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Create directory structure
echo "ðŸ“ Creating directories..."
mkdir -p wazuh-device-visualization/{backend,frontend/src/{components,utils},wazuh-config/{manager,agents/{linux,windows}},scripts,docs,docker}

cd wazuh-device-visualization

# ============================================
# BACKEND FILES
# ============================================

echo "ðŸ“ Creating backend files..."

cat > backend/package.json << 'BACKEND_PACKAGE'
{
  "name": "wazuh-backend-api",
  "version": "1.0.0",
  "description": "Backend API for Wazuh Device Visualization",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "keywords": ["wazuh", "siem", "security"],
  "author": "Your Team",
  "license": "MIT",
  "dependencies": {
    "express": "^4.18.2",
    "axios": "^1.6.0",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "ws": "^8.14.2"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  }
}
BACKEND_PACKAGE

cat > backend/.env.example << 'BACKEND_ENV'
# Wazuh Configuration
WAZUH_API_URL=https://your-wazuh-server-ip:55000
WAZUH_USER=wazuh-wui
WAZUH_PASSWORD=wazuh-wui

# Server Configuration
PORT=3001
NODE_ENV=development

# Frontend URL (for CORS)
FRONTEND_URL=http://localhost:3000
BACKEND_ENV

cat > backend/.gitignore << 'BACKEND_GITIGNORE'
node_modules/
.env
*.log
npm-debug.log*
.DS_Store
dist/
build/
BACKEND_GITIGNORE

cat > backend/README.md << 'BACKEND_README'
# Wazuh Backend API

## Quick Start

1. Install dependencies:
   \`\`\`bash
   npm install
   \`\`\`

2. Configure environment:
   \`\`\`bash
   cp .env.example .env
   nano .env  # Edit with your Wazuh details
   \`\`\`

3. Start server:
   \`\`\`bash
   npm run dev
   \`\`\`

## Endpoints

- GET /health - Health check
- GET /api/agents - List all agents
- GET /api/network-topology - Complete topology
- GET /api/agents/:id/peripherals - Agent peripherals

## WebSocket

Connect to ws://localhost:3001 for real-time updates
BACKEND_README

echo "âš ï¸  NOTE: Copy server.js content from Claude's artifact 'wazuh_backend_api'" > backend/server.js

# ============================================
# FRONTEND FILES
# ============================================

echo "ðŸ“ Creating frontend files..."

cat > frontend/package.json << 'FRONTEND_PACKAGE'
{
  "name": "wazuh-frontend",
  "version": "1.0.0",
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "vis-network": "^9.1.9",
    "axios": "^1.6.0",
    "react-router-dom": "^6.20.0"
  },
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build"
  }
}
FRONTEND_PACKAGE

cat > frontend/src/utils/api.js << 'FRONTEND_API'
import axios from 'axios';

const API_BASE_URL = process.env.REACT_APP_API_URL || 'http://localhost:3001';

const api = axios.create({
  baseURL: API_BASE_URL,
  timeout: 30000,
  headers: { 'Content-Type': 'application/json' }
});

export const getAgents = () => api.get('/api/agents');
export const getNetworkTopology = () => api.get('/api/network-topology');
export const getAgentPeripherals = (agentId) => 
  api.get(`/api/agents/${agentId}/peripherals`);

export default api;
FRONTEND_API

echo "âš ï¸  NOTE: Copy NetworkTopologyVisualization.jsx from Claude's artifact" > frontend/src/components/NetworkTopologyVisualization.jsx

# ============================================
# WAZUH CONFIGURATION FILES
# ============================================

echo "ðŸ“ Creating Wazuh configuration files..."

cat > wazuh-config/manager/local_rules.xml << 'WAZUH_RULES'
<group name="usb_devices,local">
  <!-- USB Device Connected (Windows) -->
  <rule id="100001" level="3">
    <if_sid>60009</if_sid>
    <field name="win.system.eventID">^2003$|^20001$</field>
    <description>USB device connected on Windows system</description>
    <group>usb_connected,pci_dss_10.6.1,</group>
  </rule>

  <!-- USB Device Removed (Windows) -->
  <rule id="100002" level="3">
    <if_sid>60009</if_sid>
    <field name="win.system.eventID">^2102$|^20003$</field>
    <description>USB device removed on Windows system</description>
    <group>usb_removed,</group>
  </rule>

  <!-- USB Storage Device (Linux) -->
  <rule id="100003" level="5">
    <if_sid>2902</if_sid>
    <match>usb-storage|USB_STORAGE_DETECTED</match>
    <description>USB storage device detected</description>
    <group>usb_storage,pci_dss_10.6.1,</group>
  </rule>

  <!-- USB HID Device (Keyboard/Mouse) -->
  <rule id="100005" level="2">
    <if_sid>2902,60009</if_sid>
    <match>HID|keyboard|mouse|PERIPHERAL_TYPE</match>
    <description>USB HID device connected</description>
    <group>usb_hid,peripheral,</group>
  </rule>

  <!-- Unauthorized USB (After Hours) -->
  <rule id="100010" level="10">
    <if_sid>100001,100003</if_sid>
    <time>18:00-08:00</time>
    <description>USB device connected outside business hours!</description>
    <group>usb_unauthorized,</group>
  </rule>
</group>
WAZUH_RULES

cat > wazuh-config/manager/local_decoder.xml << 'WAZUH_DECODER'
<decoder name="usb-device-linux">
  <prematch>^USB_DEVICE_CONNECTED:|^USB_STORAGE_DETECTED:|^PERIPHERAL_TYPE:</prematch>
</decoder>

<decoder name="usb-device-details">
  <parent>usb-device-linux</parent>
  <regex offset="after_parent">(\S+):\s+(.+)</regex>
  <order>device_type,device_info</order>
</decoder>
WAZUH_DECODER

cat > wazuh-config/agents/linux/ossec.conf.additions << 'LINUX_AGENT_CONFIG'
<!-- Add to /var/ossec/etc/ossec.conf on Linux agents -->

<!-- Enable Syscollector -->
<wodle name="syscollector">
  <disabled>no</disabled>
  <interval>1h</interval>
  <hardware>yes</hardware>
  <os>yes</os>
  <network>yes</network>
  <packages>yes</packages>
  <ports all="yes">yes</ports>
  <processes>yes</processes>
</wodle>

<!-- Monitor USB Logs -->
<localfile>
  <log_format>syslog</log_format>
  <location>/var/log/usb-devices.log</location>
</localfile>

<localfile>
  <log_format>command</log_format>
  <command>lsusb</command>
  <frequency>120</frequency>
</localfile>
LINUX_AGENT_CONFIG

cat > wazuh-config/agents/linux/usb-monitor.sh << 'USB_MONITOR_SCRIPT'
#!/bin/bash
# USB Device Monitoring Script
# Place in: /var/ossec/active-response/bin/usb-monitor.sh

LOG_FILE="/var/log/usb-devices.log"
touch "$LOG_FILE"

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Monitor using udevadm
udevadm monitor --property --subsystem-match=usb | while read -r line; do
    if echo "$line" | grep -q "ACTION=add"; then
        sleep 1
        device_info=$(lsusb | tail -1)
        log_message "USB_DEVICE_CONNECTED: $device_info"
        
        # Categorize device
        if echo "$device_info" | grep -iq "keyboard"; then
            log_message "PERIPHERAL_TYPE: KEYBOARD | $device_info"
        elif echo "$device_info" | grep -iq "mouse"; then
            log_message "PERIPHERAL_TYPE: MOUSE | $device_info"
        elif echo "$device_info" | grep -iq "mass storage"; then
            log_message "PERIPHERAL_TYPE: STORAGE | $device_info"
        fi
    elif echo "$line" | grep -q "ACTION=remove"; then
        log_message "USB_DEVICE_REMOVED: Device disconnected"
    fi
done
USB_MONITOR_SCRIPT

chmod +x wazuh-config/agents/linux/usb-monitor.sh

cat > wazuh-config/agents/linux/wazuh-usb-monitor.service << 'USB_SERVICE'
[Unit]
Description=Wazuh USB Device Monitor
After=wazuh-agent.service

[Service]
Type=simple
ExecStart=/var/ossec/active-response/bin/usb-monitor.sh
Restart=always
User=root

[Install]
WantedBy=multi-user.target
USB_SERVICE

cat > wazuh-config/agents/windows/ossec.conf.additions << 'WINDOWS_AGENT_CONFIG'
<!-- Add to C:\Program Files (x86)\ossec-agent\ossec.conf -->

<wodle name="syscollector">
  <disabled>no</disabled>
  <interval>1h</interval>
  <hardware>yes</hardware>
  <os>yes</os>
  <network>yes</network>
</wodle>

<localfile>
  <location>Microsoft-Windows-DriverFrameworks-UserMode/Operational</location>
  <log_format>eventchannel</log_format>
</localfile>

<localfile>
  <location>Microsoft-Windows-Kernel-PnP/Configuration</location>
  <log_format>eventchannel</log_format>
</localfile>
WINDOWS_AGENT_CONFIG

# ============================================
# INSTALLATION SCRIPTS
# ============================================

echo "ðŸ“ Creating installation scripts..."

cat > scripts/setup-backend.sh << 'SETUP_BACKEND'
#!/bin/bash
echo "ðŸš€ Setting up Backend API..."

cd backend || exit

if ! command -v node &> /dev/null; then
    echo "Installing Node.js..."
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    sudo apt-get install -y nodejs
fi

npm install

if [ ! -f .env ]; then
    cp .env.example .env
    echo "âš ï¸  Edit .env with your Wazuh details"
fi

echo "âœ… Backend setup complete!"
echo "Run: npm run dev"
SETUP_BACKEND

chmod +x scripts/setup-backend.sh

cat > scripts/setup-wazuh-manager.sh << 'SETUP_WAZUH'
#!/bin/bash
echo "ðŸ”§ Configuring Wazuh Manager..."

sudo cp wazuh-config/manager/local_rules.xml /var/ossec/etc/rules/
sudo cp wazuh-config/manager/local_decoder.xml /var/ossec/etc/decoders/

sudo systemctl restart wazuh-manager
sudo systemctl status wazuh-manager --no-pager

echo "âœ… Wazuh Manager configured!"
SETUP_WAZUH

chmod +x scripts/setup-wazuh-manager.sh

cat > scripts/setup-linux-agent.sh << 'SETUP_AGENT'
#!/bin/bash
echo "ðŸ–¥ï¸  Setting up Linux Agent..."

sudo apt-get update
sudo apt-get install -y usbutils inotify-tools

sudo cp wazuh-config/agents/linux/usb-monitor.sh /var/ossec/active-response/bin/
sudo chmod +x /var/ossec/active-response/bin/usb-monitor.sh

sudo mkdir -p /var/log/wazuh-usb
sudo touch /var/log/usb-devices.log

sudo cp wazuh-config/agents/linux/wazuh-usb-monitor.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable wazuh-usb-monitor.service
sudo systemctl start wazuh-usb-monitor.service

sudo systemctl restart wazuh-agent

echo "âœ… Agent setup complete!"
SETUP_AGENT

chmod +x scripts/setup-linux-agent.sh

# ============================================
# DOCUMENTATION
# ============================================

echo "ðŸ“ Creating documentation..."

cat > docs/INSTALLATION.md << 'INSTALL_DOC'
# Installation Guide

## Quick Start

### 1. Wazuh Manager Setup
\`\`\`bash
# Run on Wazuh Manager
cd scripts
sudo ./setup-wazuh-manager.sh
\`\`\`

### 2. Backend Setup
\`\`\`bash
# Run on backend server
cd scripts
./setup-backend.sh
\`\`\`

### 3. Agent Setup
\`\`\`bash
# Run on each Linux agent
cd scripts
sudo ./setup-linux-agent.sh
\`\`\`

### 4. Frontend Setup
\`\`\`bash
cd frontend
npm install
npm start
\`\`\`

## Verification

\`\`\`bash
# Test backend
curl http://localhost:3001/health

# Check agents
curl http://localhost:3001/api/agents

# Monitor USB events
sudo tail -f /var/log/usb-devices.log
\`\`\`

## Next Steps

1. Configure .env files
2. Test USB device detection
3. Open frontend at http://localhost:3000
4. Review security rules
INSTALL_DOC

cat > docs/README.md << 'DOCS_README'
# Documentation

## Available Guides

- [Installation Guide](INSTALLATION.md) - Setup instructions
- [Configuration Guide](CONFIGURATION.md) - System configuration
- [API Documentation](API_DOCUMENTATION.md) - API reference
- [Troubleshooting](TROUBLESHOOTING.md) - Common issues

## Quick Links

- Backend API: http://localhost:3001
- Frontend: http://localhost:3000
- Wazuh Dashboard: https://wazuh-server
DOCS_README

# ============================================
# MAIN README
# ============================================

cat > README.md << 'MAIN_README'
# ðŸ›¡ï¸ Wazuh Device Visualization & Network Topology

Complete SIEM solution with real-time USB device tracking and network visualization.

## âœ¨ Features

- âœ… Real-time network topology visualization
- âœ… Automatic USB device detection
- âœ… Security event monitoring
- âœ… Cross-platform support (Windows/Linux)
- âœ… Real-time WebSocket updates
- âœ… Device authorization workflow

## ðŸš€ Quick Start

\`\`\`bash
# 1. Setup Wazuh Manager
cd scripts && sudo ./setup-wazuh-manager.sh

# 2. Setup Backend
./setup-backend.sh

# 3. Setup Agents
sudo ./setup-linux-agent.sh

# 4. Start Frontend
cd frontend && npm install && npm start
\`\`\`

## ðŸ“š Documentation

See `docs/` folder for complete documentation.

## ðŸ—ï¸ Architecture

\`\`\`
Frontend (React) â†â†’ Backend (Node.js) â†â†’ Wazuh Manager â†â†’ Agents
\`\`\`

## ðŸ“ Important Files to Copy

The following files need content from Claude's artifacts:

1. `backend/server.js` - Copy from artifact "wazuh_backend_api"
2. `frontend/src/components/NetworkTopologyVisualization.jsx` - Copy from artifact "network_topology_viz"

All other files are complete and ready to use!

## ðŸ“ž Support

- Documentation: See `docs/` folder
- Issues: Open GitHub issue
- Email: your-team@company.com

## ðŸ“„ License

MIT License
MAIN_README

# ============================================
# CREATE INSTRUCTIONS FILE
# ============================================

cat > SETUP_INSTRUCTIONS.txt << 'INSTRUCTIONS'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   PROJECT CREATED SUCCESSFULLY!                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“¦ Project Structure Created:
   âœ… Backend configuration
   âœ… Frontend structure  
   âœ… Wazuh configuration files
   âœ… Installation scripts
   âœ… Documentation

ðŸ“ NEXT STEPS:

1. Copy Missing Files from Claude's Artifacts:
   
   a) backend/server.js
      - Open Claude conversation
      - Find artifact: "wazuh_backend_api"
      - Copy entire content
      - Paste into: backend/server.js
   
   b) frontend/src/components/NetworkTopologyVisualization.jsx
      - Find artifact: "network_topology_viz"
      - Copy entire content
      - Paste into: frontend/src/components/NetworkTopologyVisualization.jsx

2. Configure Backend:
   cd backend
   cp .env.example .env
   nano .env  # Add your Wazuh server IP and credentials

3. Install Backend:
   npm install
   npm run dev

4. Configure Wazuh Manager:
   cd scripts
   sudo ./setup-wazuh-manager.sh

5. Setup Agents:
   sudo ./setup-linux-agent.sh

6. Install Frontend:
   cd frontend
   npm install
   npm start

ðŸŽ¯ FREE SHARING OPTIONS:

Option 1: GitHub (Recommended)
   - Create free account at github.com
   - Create new repository
   - Push this folder:
     git init
     git add .
     git commit -m "Initial commit"
     git remote add origin https://github.com/your-username/wazuh-viz.git
     git push -u origin main
   
Option 2: Google Drive
   - Zip this folder
   - Upload to Google Drive
   - Share link with team

Option 3: Email/Slack
   - Zip folder
   - Send to team members

ðŸ“š Documentation:
   - Installation: docs/INSTALLATION.md
   - Configuration: Check config files in wazuh-config/
   - Scripts: All in scripts/ folder

âœ… ALL FILES CREATED! Ready to share with your team!
INSTRUCTIONS

# ============================================
# FINISH
# ============================================

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          PROJECT CREATED SUCCESSFULLY!         â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ðŸ“ Location: $(pwd)"
echo ""
echo "ðŸ“ Read SETUP_INSTRUCTIONS.txt for next steps"
echo ""
echo "âš ï¸  IMPORTANT: You need to copy 2 files from Claude:"
echo "   1. backend/server.js (from artifact 'wazuh_backend_api')"
echo "   2. frontend/src/components/NetworkTopologyVisualization.jsx"
echo ""
echo "ðŸŽ¯ FREE SHARING OPTIONS:"
echo "   1. Push to GitHub (free account)"
echo "   2. Zip and upload to Google Drive"
echo "   3. Send via email/Slack"
echo ""
echo "âœ… All configuration files, scripts, and docs created!"
echo ""
